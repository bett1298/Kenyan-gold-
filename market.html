<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farmers Marketplace</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2d6a4f;
      --primary-dark: #1b4332;
      --secondary: #ffd166;
      --danger: #d62828;
      --warning: #f77f00;
      --light: #f9f9f9;
      --dark: #333;
      --gray: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      color: var(--dark);
      line-height: 1.6;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    header h1 {
      font-size: 2.2rem;
      margin-bottom: 5px;
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    nav {
      background: var(--primary-dark);
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 4px;
      transition: var(--transition);
    }

    nav a:hover {
      background: rgba(255,255,255,0.1);
      color: var(--secondary);
    }

    .container {
      width: 90%;
      max-width: 1000px;
      margin: 25px auto;
      background: #fff;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--box-shadow);
    }

    .filters {
      margin-bottom: 20px;
      padding: 15px;
      background: var(--light);
      border-radius: var(--border-radius);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }

    .filters input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 0.95rem;
    }

    .filters button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--border-radius);
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .filters button:hover {
      background: var(--primary-dark);
    }

    .toggle-form {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      cursor: pointer;
      padding: 15px;
      background: var(--light);
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .toggle-form:hover {
      background: #f0f0f0;
    }

    .toggle-form h2 {
      color: var(--primary-dark);
      margin: 0;
    }

    .toggle-icon {
      font-size: 1.2rem;
      transition: var(--transition);
    }

    .toggle-form.collapsed .toggle-icon {
      transform: rotate(180deg);
    }

    .form-container {
      overflow: hidden;
      transition: max-height 0.4s ease;
      max-height: 1000px;
    }

    .form-container.collapsed {
      max-height: 0;
    }

    .product {
      border-bottom: 1px solid #eee;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
    }

    .product:last-child {
      border-bottom: none;
    }

    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .product h3 {
      color: var(--primary-dark);
      font-size: 1.3rem;
      margin: 0;
    }

    .price {
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--primary);
    }

    .location {
      color: var(--gray);
      margin: 5px 0;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .location i {
      font-size: 0.9rem;
    }

    .description {
      margin: 10px 0;
      line-height: 1.5;
    }

    .date {
      font-size: 0.85rem;
      color: var(--gray);
    }

    .product-images {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .product-images img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .product-images img:hover {
      transform: scale(1.05);
    }

    .action-btns {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 8px 15px;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e06d00;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #b32020;
    }

    .btn-secondary {
      background: var(--gray);
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 0.85rem;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--dark);
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(45, 106, 79, 0.2);
    }

    .file-input-container {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-input-container input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: var(--light);
      border: 1px dashed #ccc;
      border-radius: var(--border-radius);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-label:hover {
      background: #f0f0f0;
    }

    .file-input-label.has-files {
      background: rgba(45, 106, 79, 0.1);
      border-color: var(--primary);
      color: var(--primary);
    }

    .selected-files {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .file-preview {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .file-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .file-preview .remove-file {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      cursor: pointer;
    }

    .progress-container {
      margin: 15px 0;
      display: none;
    }

    .progress-bar {
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 5px;
    }

    /* Comments Section */
    .comments-section {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }

    .comments-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 10px 15px;
      background: var(--light);
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      transition: var(--transition);
    }

    .comments-toggle:hover {
      background: #f0f0f0;
    }

    .comments-toggle h4 {
      margin: 0;
      color: var(--primary-dark);
    }

    .comments-toggle .toggle-icon {
      font-size: 1rem;
    }

    .comments-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .comments-container.expanded {
      max-height: 800px;
      overflow-y: auto;
    }

    .comment-form {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .comment-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      resize: vertical;
      min-height: 60px;
    }

    .comment {
      padding: 12px;
      background: var(--light);
      border-radius: var(--border-radius);
      margin-bottom: 10px;
      position: relative;
    }

    .comment.reply {
      margin-left: 30px;
      background: #f8f9fa;
      border-left: 3px solid var(--primary);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .comment-author {
      font-weight: 600;
      color: var(--primary-dark);
    }

    .comment-date {
      font-size: 0.8rem;
      color: var(--gray);
    }

    .comment-text {
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .comment-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .reply-form {
      margin-top: 10px;
      display: none;
    }

    .reply-form.active {
      display: flex;
      gap: 10px;
    }

    .reply-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      resize: vertical;
      min-height: 50px;
      font-size: 0.9rem;
    }

    .no-comments {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-style: italic;
    }

    /* Fullscreen image */
    .fullscreen {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .fullscreen img {
      max-width: 90%;
      max-height: 80%;
      border-radius: 10px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }

    .fullscreen span {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      cursor: pointer;
      transition: var(--transition);
    }

    .fullscreen span:hover {
      color: var(--secondary);
    }

    .image-counter {
      color: white;
      margin-top: 15px;
      font-size: 1.1rem;
    }

    .fullscreen-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .fullscreen-nav:hover {
      background: rgba(255,255,255,0.3);
    }

    .fullscreen-prev {
      left: 20px;
    }

    .fullscreen-next {
      right: 20px;
    }

    /* Edit modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      color: var(--primary-dark);
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
    }

    .close-modal:hover {
      color: var(--dark);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .filters {
        grid-template-columns: 1fr;
      }
      
      .product-header {
        flex-direction: column;
        gap: 5px;
      }
      
      nav {
        gap: 15px;
      }
      
      .product-images img {
        width: 100px;
        height: 100px;
      }
      
      .comment-form {
        flex-direction: column;
      }
      
      .reply-form.active {
        flex-direction: column;
      }
      
      .comment.reply {
        margin-left: 15px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1><i class="fas fa-seedling"></i> Farmers Marketplace</h1>
  <p>Buy & Sell Farm Products Directly</p>
</header>

<nav>
  <a href="index.html"><i class="fas fa-comments"></i> HOME</a>
  <a href="gold forum.html" class="active"><i class="fas fa-store"></i> FORUM</a>
  <a href="ai.html"><i class="fas fa-robot"></i> AI & EXPERTS</a>
</nav>

<div class="container">
  <!-- Toggle for Add Product Form -->
  <div class="toggle-form" id="toggleForm">
    <h2><i class="fas fa-plus-circle"></i> Add Your Product</h2>
    <div class="toggle-icon">
      <i class="fas fa-chevron-down"></i>
    </div>
  </div>

  <!-- Add Product Form -->
  <div class="form-container" id="formContainer">
    <div class="form-group">
      <label for="pname">Product Name</label>
      <input type="text" id="pname" placeholder="Enter product name">
    </div>
    
    <div class="form-group">
      <label for="price">Price (Ksh)</label>
      <input type="text" id="price" placeholder="Enter price (e.g. 500)">
    </div>
    
    <div class="form-group">
      <label for="location">Location</label>
      <input type="text" id="location" placeholder="Enter your location">
    </div>
    
    <div class="form-group">
      <label for="desc">Description</label>
      <textarea id="desc" rows="3" placeholder="Write a short description..."></textarea>
    </div>
    
    <div class="form-group">
      <label for="imageInput">Product Images (Multiple)</label>
      <div class="file-input-container">
        <div class="file-input-label" id="fileInputLabel">
          <i class="fas fa-cloud-upload-alt"></i>
          <span>Choose image files</span>
        </div>
        <input type="file" id="imageInput" accept="image/*" multiple>
      </div>
      <div class="selected-files" id="selectedFiles"></div>
    </div>
    
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Uploading: 0%</div>
    </div>
    
    <button class="btn-primary" id="postButton" onclick="postProduct()">
      <i class="fas fa-paper-plane"></i> Post Product
    </button>
  </div>
</div>

<div class="container">
  <div class="filters">
    <input type="text" id="searchProduct" placeholder="Search by product name">
    <input type="text" id="searchLocation" placeholder="Search by location">
    <input type="number" id="minPrice" placeholder="Min price">
    <input type="number" id="maxPrice" placeholder="Max price">
    <button onclick="applyFilters()"><i class="fas fa-filter"></i> Filter</button>
    <button onclick="resetFilters()"><i class="fas fa-redo"></i> Reset</button>
  </div>

  <div id="market-container">
    <div class="empty-state">
      <i class="fas fa-seedling"></i>
      <h3>No Products Available</h3>
      <p>Be the first to add a product to the marketplace!</p>
    </div>
  </div>
</div>

<!-- Fullscreen Image -->
<div class="fullscreen" id="fullscreen">
  <span onclick="closeFullscreen()">&times;</span>
  <button class="fullscreen-nav fullscreen-prev" onclick="prevImage()">
    <i class="fas fa-chevron-left"></i>
  </button>
  <button class="fullscreen-nav fullscreen-next" onclick="nextImage()">
    <i class="fas fa-chevron-right"></i>
  </button>
  <img id="fullscreen-img">
  <div class="image-counter" id="imageCounter"></div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-edit"></i> Edit Product</h3>
      <button class="close-modal" onclick="closeEditModal()">&times;</button>
    </div>
    
    <div class="form-group">
      <label for="editName">Product Name</label>
      <input type="text" id="editName">
    </div>
    
    <div class="form-group">
      <label for="editPrice">Price (Ksh)</label>
      <input type="text" id="editPrice">
    </div>
    
    <div class="form-group">
      <label for="editLocation">Location</label>
      <input type="text" id="editLocation">
    </div>
    
    <div class="form-group">
      <label for="editDesc">Description</label>
      <textarea id="editDesc" rows="3"></textarea>
    </div>
    
    <div class="modal-footer">
      <button class="btn-primary" onclick="saveEdit()"><i class="fas fa-save"></i> Save Changes</button>
      <button class="btn-warning" onclick="closeEditModal()"><i class="fas fa-times"></i> Cancel</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDUYnN3bOTPNHvKHdWwrlACOAnLCAgxiJI",
    authDomain: "manuu-59b30.firebaseapp.com",
    databaseURL: "https://manuu-59b30-default-rtdb.firebaseio.com/",
    projectId: "manuu-59b30",
    storageBucket: "manuu-59b30.firebasestorage.app",
    messagingSenderId: "872309397811",
    appId: "1:872309397811:web:ebe13952c02b7394954646"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const imgbbAPI = "856921ff2f38a58ad9138a0c66a976bd";
  const marketContainer = document.getElementById("market-container");

  let allProducts = [];
  let editKey = null; // track key being edited

  // DOM elements for progress tracking
  const progressContainer = document.getElementById("progressContainer");
  const progressFill = document.getElementById("progressFill");
  const progressText = document.getElementById("progressText");
  const postButton = document.getElementById("postButton");
  const fileInputLabel = document.getElementById("fileInputLabel");
  const imageInput = document.getElementById("imageInput");
  const selectedFiles = document.getElementById("selectedFiles");
  const toggleForm = document.getElementById("toggleForm");
  const formContainer = document.getElementById("formContainer");

  // Toggle form visibility
  toggleForm.addEventListener('click', () => {
    toggleForm.classList.toggle('collapsed');
    formContainer.classList.toggle('collapsed');
  });

  // Track selected files for multiple image upload
  let selectedFilesList = [];

  // Update file input label when files are selected
  imageInput.addEventListener('change', function() {
    selectedFilesList = Array.from(this.files);
    
    if (selectedFilesList.length > 0) {
      fileInputLabel.classList.add('has-files');
      fileInputLabel.innerHTML = `<i class="fas fa-check-circle"></i> ${selectedFilesList.length} file(s) selected`;
      
      // Show file previews
      selectedFiles.innerHTML = '';
      selectedFilesList.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.createElement('div');
          preview.className = 'file-preview';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button class="remove-file" onclick="removeSelectedFile(${index})">
              <i class="fas fa-times"></i>
            </button>
          `;
          selectedFiles.appendChild(preview);
        };
        reader.readAsDataURL(file);
      });
    } else {
      fileInputLabel.classList.remove('has-files');
      fileInputLabel.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Choose image files`;
      selectedFiles.innerHTML = '';
    }
  });

  // Remove selected file
  window.removeSelectedFile = (index) => {
    selectedFilesList.splice(index, 1);
    
    // Update the file input
    const dt = new DataTransfer();
    selectedFilesList.forEach(file => dt.items.add(file));
    imageInput.files = dt.files;
    
    // Trigger change event to update UI
    const event = new Event('change');
    imageInput.dispatchEvent(event);
  };

  // Post product
  async function postProduct() {
    const pname = document.getElementById("pname").value.trim();
    const price = document.getElementById("price").value.trim();
    const location = document.getElementById("location").value.trim();
    const desc = document.getElementById("desc").value.trim();
    const files = selectedFilesList;

    if (!pname || !price || !location || !desc) {
      alert("Please fill in all required fields");
      return;
    }

    // Disable button and show progress
    postButton.disabled = true;
    postButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Uploading...`;

    let imageUrls = [];
    if (files.length > 0) {
      // Show progress bar
      progressContainer.style.display = 'block';
      
      try {
        imageUrls = await uploadMultipleImagesWithProgress(files);
      } catch (error) {
        alert("Image upload failed: " + error.message);
        resetFormState();
        return;
      }
    }

    // Hide progress bar
    progressContainer.style.display = 'none';

    // Push to Firebase
    push(ref(db, "marketProducts"), {
      pname, 
      price: Number(price), 
      location, 
      desc, 
      imageUrls,
      date: new Date().toLocaleString()
    }).then(() => {
      // Reset form
      document.querySelectorAll('#pname,#price,#location,#desc').forEach(i => i.value = "");
      selectedFilesList = [];
      selectedFiles.innerHTML = '';
      fileInputLabel.classList.remove('has-files');
      fileInputLabel.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Choose image files`;
      imageInput.value = '';
      
      // Show success message
      showNotification("Product posted successfully!", "success");
    }).catch((error) => {
      alert("Error posting product: " + error.message);
    }).finally(() => {
      resetFormState();
    });
  }

  // Upload multiple images with progress tracking
  function uploadMultipleImagesWithProgress(files) {
    return new Promise((resolve, reject) => {
      const totalFiles = files.length;
      let uploadedCount = 0;
      const imageUrls = [];
      
      files.forEach((file, index) => {
        const formData = new FormData();
        formData.append("image", file);

        const xhr = new XMLHttpRequest();
        
        // Track upload progress for individual file
        xhr.upload.addEventListener("progress", (event) => {
          if (event.lengthComputable) {
            const fileProgress = (event.loaded / event.total) * 100;
            const overallProgress = ((uploadedCount + (fileProgress / 100)) / totalFiles) * 100;
            progressFill.style.width = overallProgress + '%';
            progressText.textContent = `Uploading: ${Math.round(overallProgress)}% (${uploadedCount + 1}/${totalFiles})`;
          }
        });

        xhr.addEventListener("load", () => {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            imageUrls.push(data.data.url);
            uploadedCount++;
            
            if (uploadedCount === totalFiles) {
              resolve(imageUrls);
            }
          } else {
            reject(new Error(`Upload failed for file ${index + 1}`));
          }
        });

        xhr.addEventListener("error", () => {
          reject(new Error(`Upload failed for file ${index + 1}`));
        });

        xhr.open("POST", `https://api.imgbb.com/1/upload?key=${imgbbAPI}`);
        xhr.send(formData);
      });
    });
  }

  // Reset form state after upload
  function resetFormState() {
    postButton.disabled = false;
    postButton.innerHTML = `<i class="fas fa-paper-plane"></i> Post Product`;
    progressContainer.style.display = 'none';
    progressFill.style.width = '0%';
    progressText.textContent = 'Uploading: 0%';
  }

  // Show notification
  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      </div>
    `;
    
    // Add styles for notification
    const style = document.createElement('style');
    style.textContent = `
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      }
      .notification.success {
        background: var(--primary);
      }
      .notification.error {
        background: var(--danger);
      }
      .notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }

  // Load all products
  onValue(ref(db, "marketProducts"), (snapshot) => {
    allProducts = [];
    snapshot.forEach((child) => {
      const productData = child.val();
      allProducts.push({ 
        id: child.key, 
        ...productData,
        // Ensure comments array exists
        comments: productData.comments || []
      });
    });
    renderProducts(allProducts);
  });

  // Render
  function renderProducts(list) {
    if (list.length === 0) {
      marketContainer.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-seedling"></i>
          <h3>No Products Available</h3>
          <p>Be the first to add a product to the marketplace!</p>
        </div>
      `;
      return;
    }

    marketContainer.innerHTML = "";
    list.forEach(p => {
      const div = document.createElement("div");
      div.className = "product";
      div.innerHTML = `
        <div class="product-header">
          <h3>${p.pname}</h3>
          <div class="price">Ksh ${p.price}</div>
        </div>
        <div class="location">
          <i class="fas fa-map-marker-alt"></i> ${p.location}
        </div>
        <div class="description">${p.desc}</div>
        <div class="date">
          <i class="far fa-clock"></i> ${p.date}
        </div>
        ${p.imageUrls && p.imageUrls.length > 0 ? `
          <div class="product-images">
            ${p.imageUrls.map((url, index) => 
              `<img src="${url}" onclick="openFullscreen('${p.id}', ${index})">`
            ).join('')}
          </div>
        ` : ""}
        <div class="action-btns">
          <button class="btn-warning" onclick="openEditModal('${p.id}')">
            <i class="fas fa-edit"></i> Edit
          </button>
          <button class="btn-danger" onclick="deleteProduct('${p.id}')">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
        
        <!-- Comments Section -->
        <div class="comments-section">
          <div class="comments-toggle" onclick="toggleComments('${p.id}')">
            <h4><i class="fas fa-comments"></i>   Comments (${getTotalComments(p.comments)})</h4>
            <div class="toggle-icon">
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
          <div class="comments-container" id="comments-${p.id}">
            <div class="comment-form">
              <textarea class="comment-input" id="comment-input-${p.id}" placeholder="Ask a question or negotiate the price..."></textarea>
              <button class="btn-secondary" onclick="postComment('${p.id}')">
                <i class="fas fa-paper-plane"></i> Post
              </button>
            </div>
            <div class="comments-list" id="comments-list-${p.id}">
              ${renderComments(p.comments, p.id)}
            </div>
          </div>
        </div>
      `;
      marketContainer.prepend(div);
    });
  }

  // Render comments with replies
  function renderComments(comments, productId) {
    if (!comments || comments.length === 0) {
      return '<div class="no-comments">No comments yet. Be the first to comment!</div>';
    }
    
    let html = '';
    comments.forEach((comment, index) => {
      // Check if this comment has replies
      const hasReplies = comment.replies && comment.replies.length > 0;
      const replyCount = hasReplies ? comment.replies.length : 0;
      
      html += `
        <div class="comment" id="comment-${productId}-${index}">
          <div class="comment-header">
            <span class="comment-author">${comment.author || 'Anonymous'}</span>
            <span class="comment-date">${comment.date || 'Just now'}</span>
          </div>
          <div class="comment-text">${comment.text}</div>
          <div class="comment-actions">
            <button class="btn-outline btn-small" onclick="toggleReplyForm('${productId}', ${index})">
              <i class="fas fa-reply"></i> Reply
            </button>
            ${replyCount > 0 ? `<span class="reply-count">${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}</span>` : ''}
          </div>
          <div class="reply-form" id="reply-form-${productId}-${index}">
            <textarea class="reply-input" id="reply-input-${productId}-${index}" placeholder="Write a reply..."></textarea>
            <button class="btn-outline btn-small" onclick="postReply('${productId}', ${index})">
              <i class="fas fa-paper-plane"></i> Reply
            </button>
          </div>
          ${hasReplies ? renderReplies(comment.replies, productId, index) : ''}
        </div>
      `;
    });
    
    return html;
  }

  // Render replies to comments
  function renderReplies(replies, productId, commentIndex) {
    let html = '';
    replies.forEach((reply, replyIndex) => {
      html += `
        <div class="comment reply" id="reply-${productId}-${commentIndex}-${replyIndex}">
          <div class="comment-header">
            <span class="comment-author">${reply.author || 'Anonymous'}</span>
            <span class="comment-date">${reply.date || 'Just now'}</span>
          </div>
          <div class="comment-text">${reply.text}</div>
        </div>
      `;
    });
    return html;
  }

  // Get total comments including replies
  function getTotalComments(comments) {
    if (!comments) return 0;
    
    let total = comments.length;
    comments.forEach(comment => {
      if (comment.replies) {
        total += comment.replies.length;
      }
    });
    
    return total;
  }

  // Toggle comments visibility
  window.toggleComments = (productId) => {
    const commentsContainer = document.getElementById(`comments-${productId}`);
    const toggleIcon = commentsContainer.previousElementSibling.querySelector('.toggle-icon i');
    
    commentsContainer.classList.toggle('expanded');
    if (commentsContainer.classList.contains('expanded')) {
      toggleIcon.className = 'fas fa-chevron-up';
    } else {
      toggleIcon.className = 'fas fa-chevron-down';
    }
  };

  // Toggle reply form
  window.toggleReplyForm = (productId, commentIndex) => {
    const replyForm = document.getElementById(`reply-form-${productId}-${commentIndex}`);
    replyForm.classList.toggle('active');
  };

  // Post comment
  window.postComment = (productId) => {
    const commentInput = document.getElementById(`comment-input-${productId}`);
    const commentText = commentInput.value.trim();
    
    if (!commentText) {
      alert("Please enter a comment");
      return;
    }
    
    // Get current product
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;
    
    // Create new comment
    const newComment = {
      text: commentText,
      author: "User" + Math.floor(Math.random() * 1000), // In a real app, this would be the logged in user
      date: new Date().toLocaleString()
    };
    
    // Update comments array
    const updatedComments = [...(product.comments || []), newComment];
    
    // Update in Firebase
    update(ref(db, "marketProducts/" + productId), {
      comments: updatedComments
    }).then(() => {
      // Clear input
      commentInput.value = "";
      
      // Show success message
      showNotification("Comment posted successfully!", "success");
    }).catch((error) => {
      alert("Error posting comment: " + error.message);
    });
  };

  // Post reply to comment
  window.postReply = (productId, commentIndex) => {
    const replyInput = document.getElementById(`reply-input-${productId}-${commentIndex}`);
    const replyText = replyInput.value.trim();
    
    if (!replyText) {
      alert("Please enter a reply");
      return;
    }
    
    // Get current product
    const product = allProducts.find(p => p.id === productId);
    if (!product || !product.comments || !product.comments[commentIndex]) return;
    
    // Create new reply
    const newReply = {
      text: replyText,
      author: "User" + Math.floor(Math.random() * 1000), // In a real app, this would be the logged in user
      date: new Date().toLocaleString()
    };
    
    // Update replies array
    const comment = product.comments[commentIndex];
    const updatedReplies = [...(comment.replies || []), newReply];
    
    // Create updated comments array
    const updatedComments = [...product.comments];
    updatedComments[commentIndex] = {
      ...comment,
      replies: updatedReplies
    };
    
    // Update in Firebase
    update(ref(db, "marketProducts/" + productId), {
      comments: updatedComments
    }).then(() => {
      // Clear input and hide form
      replyInput.value = "";
      document.getElementById(`reply-form-${productId}-${commentIndex}`).classList.remove('active');
      
      // Show success message
      showNotification("Reply posted successfully!", "success");
    }).catch((error) => {
      alert("Error posting reply: " + error.message);
    });
  };

  // Delete product
  window.deleteProduct = (id) => {
    if (confirm("Are you sure you want to delete this product?")) {
      remove(ref(db, "marketProducts/" + id));
      showNotification("Product deleted successfully!", "success");
    }
  };

  // Edit modal
  window.openEditModal = (id) => {
    const prod = allProducts.find(p => p.id === id);
    if (!prod) return;
    editKey = id;
    document.getElementById("editName").value = prod.pname;
    document.getElementById("editPrice").value = prod.price;
    document.getElementById("editLocation").value = prod.location;
    document.getElementById("editDesc").value = prod.desc;
    document.getElementById("editModal").style.display = "flex";
  };

  window.closeEditModal = () => document.getElementById("editModal").style.display = "none";

  // Save edits
  window.saveEdit = () => {
    if (!editKey) return;
    const pname = document.getElementById("editName").value.trim();
    const price = document.getElementById("editPrice").value.trim();
    const location = document.getElementById("editLocation").value.trim();
    const desc = document.getElementById("editDesc").value.trim();

    if (!pname || !price || !location || !desc) {
      alert("Please fill in all fields");
      return;
    }

    update(ref(db, "marketProducts/" + editKey), { pname, price: Number(price), location, desc });
    closeEditModal();
    showNotification("Product updated successfully!", "success");
  };

  // Filters
  window.applyFilters = () => {
    const name = document.getElementById("searchProduct").value.toLowerCase();
    const loc = document.getElementById("searchLocation").value.toLowerCase();
    const min = +document.getElementById("minPrice").value || 0;
    const max = +document.getElementById("maxPrice").value || Infinity;

    const filtered = allProducts.filter(p =>
      p.pname.toLowerCase().includes(name) &&
      p.location.toLowerCase().includes(loc) &&
      p.price >= min && p.price <= max
    );
    renderProducts(filtered);
  };

  window.resetFilters = () => {
    document.getElementById("searchProduct").value = "";
    document.getElementById("searchLocation").value = "";
    document.getElementById("minPrice").value = "";
    document.getElementById("maxPrice").value = "";
    renderProducts(allProducts);
  };

  // Fullscreen image viewer with navigation
  let currentProductId = null;
  let currentImageIndex = 0;

  window.openFullscreen = (productId, imageIndex) => {
    const product = allProducts.find(p => p.id === productId);
    if (!product || !product.imageUrls || product.imageUrls.length === 0) return;
    
    currentProductId = productId;
    currentImageIndex = imageIndex;
    
    document.getElementById("fullscreen").style.display = "flex";
    document.getElementById("fullscreen-img").src = product.imageUrls[currentImageIndex];
    updateImageCounter();
  };
  
  window.closeFullscreen = () => document.getElementById("fullscreen").style.display = "none";
  
  window.prevImage = () => {
    const product = allProducts.find(p => p.id === currentProductId);
    if (!product) return;
    
    currentImageIndex = (currentImageIndex - 1 + product.imageUrls.length) % product.imageUrls.length;
    document.getElementById("fullscreen-img").src = product.imageUrls[currentImageIndex];
    updateImageCounter();
  };
  
  window.nextImage = () => {
    const product = allProducts.find(p => p.id === currentProductId);
    if (!product) return;
    
    currentImageIndex = (currentImageIndex + 1) % product.imageUrls.length;
    document.getElementById("fullscreen-img").src = product.imageUrls[currentImageIndex];
    updateImageCounter();
  };
  
  function updateImageCounter() {
    const product = allProducts.find(p => p.id === currentProductId);
    if (!product) return;
    
    document.getElementById("imageCounter").textContent = 
      `${currentImageIndex + 1} / ${product.imageUrls.length}`;
  }

  window.postProduct = postProduct;
</script>
</body>
</html>